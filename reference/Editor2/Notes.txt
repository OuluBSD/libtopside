This must be partially rewritten, because a lot of code is very old and newer replacements should be used.
